# dsk-base-agent

## Installing DataSaker Base agent in Kubernetes environment

`Base agent` collects various information generated by the server in real time. For example, you can collect various information such as server performance indicators such as memory and CPU usage, network traffic, and container information. This allows customers to monitor server status in real time, and based on this, optimize server performance and increase stability. We tailor agent settings to your needs to deliver optimal results.

## Did you run the DataSaker predecessor?

If the preceding task of `DataSaker` has not been carried out in the current Kubernetes environment, please proceed with the preceding task of `DataSaker` first. [DataSaker predecessors] (README.md)

## Install the base agent

### 1. Base agent setting value registration
```shell
cat << EOF >> ~/datasaker/config.yaml

baseAgent:
  enabled: true
  enableMaster: true
  nodeAgent:
    logLevel: 'INFO'
  containerAgent:
    logLevel: 'INFO'
EOF
```
A detailed explanation of each setting value is as follows.

| settings | Description |
| ----------------------------------- | -------------------------------------------------- |
| `baseAgent.enabled` | Determines whether to enable the `base agent`. |
| `baseAgent.enableMaster` | Determines whether to deploy the `base agent` to the `control-plane` nodes as well. |
| `baseAgent.nodeAgent.logLevel` | Sets the log level of `node agent`. |
| `baseAgent.containerAgent.logLevel` | Sets the log level for `container agent`. |

### 2. Base agent installation
```shell
helm upgrade datasaker datasaker/agent-helm -n datasaker \
  -f ~/datasaker/config.yaml
```
## troubleshooting

### port usage issue

Base Agent uses two ports in the installation environment for monitoring. (default=`14194`,`19110`) When the corresponding port is already occupied by another program on the server, the base agent cannot start normally and outputs the following log.
```shell
ts=2023-03-14T02:54:49.460Z caller=node_exporter.go:201 level=error err="listen tcp :19110: bind: address already in use"
{"level":"error","ts":"2023-03-14T02:54:49Z","msg":"error occurred from subprocess","error":"error occured during running child process. err: exit status 1"}
{"level":"error","ts":"2023-03-14T02:54:49Z","msg":"error occurred from subprocess","error":"exporter exit unexpectedly and retry count exceeded"}
{"level":"fatal","ts":"2023-03-14T02:54:49Z","msg":"child process is terminated unexpectedly, please check other logs","error":"exporter exit unexpectedly and retry count exceeded"}
```
To fix this, you can add a `listenPort` setting to your config.yaml file.

For example, to change port 19110 used by `node agent` inside `base agent` to 19111, you can modify the configuration as follows.
```yaml
baseAgent:
  enabled: true
  enableMaster: true
  nodeAgent:
    logLevel: 'INFO'
    listenPort: 19111
  containerAgent:
    logLevel: 'INFO'
```
