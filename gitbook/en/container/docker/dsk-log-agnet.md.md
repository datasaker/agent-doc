# dsk-log-agent

## Install Datasaker Log agent in Docker environment

A `Log agent` is an agent that collects, processes and transmits log data generated by systems or applications in near real time in various environments. It can be used to centrally manage and analyze log data generated by multiple servers through `Log agent`. As a result, users can quickly detect and respond to problems occurring in the system or applications. In addition, log data can be analyzed and used for various purposes such as security, performance, and business analysis. We tailor agent settings to your needs to deliver optimal results.

## Did you run the DataSaker predecessor?

If the preceding task of `DataSaker` has not been carried out in the current Docker environment, please proceed with the preceding task of `DataSaker` first. [DataSaker predecessor](dsk-log-agent/en/$%7BPREPARATION\_MANUAL\_KR%7D/)

## Install Log agent

To collect logs through the agent, the log path the user wants to collect must be mounted on the agent.

### 1. Create the configuration YAML file required to run the agent.

Create an agent configuration YAML file based on the path where you mounted the log volume on the agent.

If you mount the log path you want to collect (e.g. `/var/lib/docker/containers/`) to a specific path (e.g. `/var/log/sample/`) of the agent, the configuration file as follows can be written.

```shell
cat << EOF > ~/.datasaker/log-agent-config.yml
agent:
  metadata:
    agent_name: 'dsk-log-agent'
  collect:
    -paths:
        - '/var/log/sample/*.log'
      exclude_paths:
        - '/var/log/sample/private.log'
      keywords:
        - 'ERROR'
        - 'WARNING'
      tag: 'Sample Service'
      service:
        name: 'Sample'
        category: 'database'
        type: 'postgres'
        address: 'my-sample-service:5432'
EOF
```

**\[Caution]** `agent.collect.paths[]` configuration items must be created based on the mounted volume path (eg '/var/log/sample/'). In this case, the log agent may not operate normally.

The description of each setting item in the log agent configuration file is as follows.

| **Settings** | **Description** | **Default** | **Necessary** |
| -------------------------------- | --------------------------------------------------------------------------------------- | :-------------: | :----------: |
| `agent.metadata.agent_name` | log agent name | `dsk-log-agent` | |
| `agent.collect.paths[]` | Log collection destination path (e.g. /var/log/sample/\*.log) | N/A | **✓** |
| `agent.collect.exclude_paths[]` | Log collection exclusion target path | N/A | |
| `agent.collect.keywords[]` | Log Collection Keywords (Only logs containing keywords are collected.) | N/A | |
| `agent.collect.tag` | custom tags | N/A | |
| `agent.collect.service.name` | service name | `default` | |
| `agent.collect.service.category` | Service category (write one of `app`, `database`, `syslog`, `etc` value) | `etc` | |
| `agent.collect.service.type` | Service database type and development language type (write one value among `postgres`, `mysql`, `java`, `etc`) | `etc` | |
| `agent.collect.service.address` | Database host and port information (Set when the service category is database. If not set, certain functions may not be available.) | N/A | ⚠️ |

### 2. Run the log agent using the docker command.

* Mount configuration files required by the log agent. (global, agent YAML configuration files)
  * `-v ~/.datasaker/config.yml:/etc/datasaker/global-config.yml:ro`
  * `-v ~/.datasaker/log-agent-config.yml:/etc/datasaker/dsk-log-agent/agent-config.yml:ro`
  * **\[Note]** The global and agent configuration files must be written. If not written, the log agent may not operate normally.
* Mount the logs the user wants to collect on the agent.
  * Set options as follows. `-v [COLLECT LOG PATH]:[LOG AGENT MOUNT PATH]:ro`
    * In that option, the path before ':' creates the path to collect logs, and the path after ':' creates the path of the agent to collect logs.
    * The log collection path of the agent configuration file must be created relative to the path `[LOG AGENT MOUNT PATH]`.
* When mounting log files, you must set the `-mount.volume=true` option.

Here is an example log agent run:

```shell
docker run -d --name dsk-log-agent \
  -v /var/datasaker/:/var/datasaker/ \
  -v ~/.datasaker/config.yml:/etc/datasaker/global-config.yml:ro \
  -v ~/.datasaker/log-agent-config.yml:/etc/datasaker/dsk-log-agent/agent-config.yml:ro \
  -v /var/lib/docker/containers/:/var/log/sample/:ro \
  --restart=always \
  datasaker/dsk-log-agent:latest \
  -mount.volume=true
```

## Log agent usage example

You can set up collection in a variety of ways, using log agent configuration files as appropriate.

* Logs from different paths can be collected under one service name. (Write multiple log file paths in `paths`.)
* Different servicesYou can collect log files of class 'category' into one service name. (After writing different `collect`, write the same `service.name` item.)
* You can collect all log files in a specific path. (Use `*` to set the log collection path.) In addition, if there are log files you want to exclude from the path, write them in `exclude_paths`.

The following is an example log collection setting.

```yaml
agent:
  metadata:
    agent_name: 'Apple & Banana Service Log Agent'
  collect:
    -paths:
        - '~/datasaker/log/apple/app/*.log'
      keywords:
        - '400'
        - '500'
      service:
        name: 'Apple'
        category: 'app'
        type: 'java'
    -paths:
        - '~/datasaker/log/apple/database/*.log'
      keywords:
        - 'ERROR'
      service:
        name: 'Apple'
        category: 'database'
        type: 'postgres'
        address: 'apple-service:5432'
    -paths:
        - '~/datasaker/log/banana/app/*.log'
      keywords:
        - 'ERROR'
      service:
        name: 'Banana'
        category: 'app'
        type: 'etc'
```

```shell
docker run -d --name dsk-log-agent \
  -v /var/datasaker/:/var/datasaker/ \
  -v ~/.datasaker/config.yml:/etc/datasaker/global-config.yml:ro \
  -v ~/.datasaker/log-agent-config.yml:/etc/datasaker/dsk-log-agent/agent-config.yml:ro \
  -v ~/var/lib/docker/containers/APPLE-APP-SERVER:~/datasaker/apple/app/:ro \
  -v ~/var/lib/docker/containers/APPLE-DB-SERVER:~/datasaker/apple/database/:ro \
  -v ~/var/lib/docker/containers/BANANA-APP-SERVER:~/datasaker/banana/app/:ro \
  --restart=always \
  datasaker/dsk-log-agent:latest \
  -mount.volume=true
```