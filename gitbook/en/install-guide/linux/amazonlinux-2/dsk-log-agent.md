# dsk-log-agent

A `Log agent` is an agent that collects, processes, and transmits log data generated by systems or applications in near real-time in various environments. It can be used to centrally manage and analyze log data generated by multiple servers through `Log agent`. As a result, users can quickly detect and respond to problems occurring in the system or applications. In addition, log data can be analyzed and used for various purposes such as security, performance, and business analysis. We tailor agent settings to your needs to deliver optimal results.

## Did you run the DataSaker predecessor?

If the preceding task of `DataSaker` has not been carried out in the current Amazon Linux 2 environment, please proceed with the preceding task of `DataSaker` first. [DataSaker predecessors] (README.md)

## Install Log agent

### Install the fluent-bit package

`Log agent` collects logs through fluent-bit, so fluent-bit version 2.1.0 or higher must be installed when installing the agent.

Install fluent-bit 2.1.0 or higher using the following command.
```shell
curl https://raw.githubusercontent.com/fluent/fluent-bit/master/install.sh | sh
```
For details on installing the fluent-bit package, refer to the [official document](https://docs.fluentbit.io/manual/installation/linux/amazon-linux).

### 1. Install the package
```shell
yum install dsk-log-agent
```
### 2. agent-config settings

Create agent-config file in `/etc/datasaker/dsk-log-agent/agent-config.yml` path.

For example, if you are collecting log files, you could write a configuration file like this:
```yaml
agent:
  logs:
    - collect:
        type: file
        file:
          paths:
            - '/var/log/sample/*.log'
```
> Caution: Set the log collection target path so that files other than log files are not set. Specify a file in the log collection path or exclude other files. Be sure to write the file extension format in log collection settings. (e.g. `.log`)

### 3. Run the package
```shell
systemctl enable dsk-log-agent --now
```
### 4. Check package execution status
```shell
systemctl status dsk-log-agent
```
## Remove Log agent

### 1. Abort the package
```shell
systemctl stop dsk-log-agent
```
### 2. Remove packages

Be sure to stop and remove the package before uninstalling it.
```shell
yum remove dsk-log-agent
```
## Set Log agent configuration

If you want to change log agent log collection settings, modify the configuration file in the `/etc/datasaker/dsk-log-agent/agent-config.yml` path.

Following is a description of each setting item in the log agent configuration file.
```yaml
agent:
  metadata:
    agent_name:
    cluster_id:
  logs:
    - service:
      tag: []
      keyword: []
      multiline:
        format:
        pattern: []
      masking:
        - pattern:
          replace:
      collect:
        type:
        category:
        address:
        file:
          paths: []
          exclude_paths: []
```
| **Settings** | **Description** | **Default** |
| ----------------------------------- | --------------------------------------------------------------------------------------- |:-----------------:|
| **metadata** | Agent basic information |
| `agent_name` | log agent name | `dsk-log-agent` |
| `cluster_id` | Cluster information of the environment to be monitored | `unknown` |
| **logs** | Log collection target information | |
| `service` | Service name of the log collection destination | `default` |
| `tag` | Tag of log collection target | |
| `keyword` | Log Collection Keywords (collects only logs containing keywords) | |
| **multiline** | Multi-line log collection settings | |
| `format` | multi-line log format (eg go, java, python) | |
| `pattern` | Multi-line log pattern (e.g. ^\d{4}-\d{2}-\d{2}) - User custom regex pattern can be used | |
| **masking** | Sensitive information log masking settings | |
| `pattern` | Log pattern to mask (e.g. ^\d{4}-\d{2}-\d{2}) - user custom regex pattern available | |
| `replace` | The string where the masking pattern is to be replaced (eg ******) | |
| **collect** | Log Collection Target Settings | |
| `type` | Log collection method (write one value among `file` or `driver`) | `file` |
| `category` | service classification (write a value of one of `app`, `database`, `syslog`, `etc`) | `etc` |
| `address` | Database host and port information (set when the service category is database) | |
| **file** | If the log collection method is file, set | |
| `paths` | Log collection destination path (e.g. /var/log/sample/*.log) | `/var/log/*.log` |
| `exclude_paths` | Log collection exclusion target path | |

## Log agent log collection setup

`Log agent` supports multi-line log collection and log masking settings via the agent configuration YAML file.

### 1. Multi-line log collection settings

Log agent configuration YAML files support multi-line log collection settings in two ways.

* **format** : Sets the multi-line log format. Currently, three formats are supported: `go`, `java` and `python`.
* **pattern** : Sets the multi-line log pattern. You can use your custom regular expression pattern.
```yaml
logs:
  - multiline:
      format:
      pattern: []
```
For example, if you have a multi-line log like this:
```shell
Dec 14 06:41:08 Exception in thread "main" java.lang.RuntimeException: Something has gone wrong, aborting!
    at com.myproject.module.MyProject.badMethod(MyProject.java:22)
    at com.myproject.module.MyProject.oneMoreMethod(MyProject.java:18)
    at com.myproject.module.MyProject.anotherMethod(MyProject.java:14)
    at com.myproject.module.MyProject.someMethod(MyProject.java:10)
    at com.myproject.module.MyProject.main(MyProject.java:6)
```
You can collect multi-line logs as follows through the `format` setting.
```yaml
logs:
  - multiline:
      format: 'java'
```
**\[Caution]** The method of collecting multi-line logs through `format` cannot collect multi-line logs of all patterns. For accurate multi-line log collection, it is recommended to configure multi-line log collection through `pattern`.

In the case of collecting multi-line logs through `pattern`, which is another method, it can be written as follows.
```yaml
logs:
  - multiline:
      pattern: 
        - '^\w*\s\d{1,2}\s\d{1,2}\:\d{1,2}\:\d{1,2}'
```
If you create a pattern at the beginning of a log for multi-line logs, multi-line logs are collected based on logs starting with the pattern.

**\[Caution]** The log agent determines that the second line in multi-line log collection starts with a blank space.

### 2. Set sensitive information log masking

Log agent configuration YAML files support sensitive log masking settings.

* **pattern** : Sets the log pattern to be masked. You can use your custom regular expression pattern.
* **replace** : Sets the string to be replaced with the masking pattern.
```yaml
logs:
  - masking:
      - pattern:
        replace:
```
For example, if you have the following log,
```shell
2023-08-18 06:35:38.993 GMT [739243] LOG:  statement:
            SELECT * 
            FROM address 
            WHERE id = '1234567890';
```
If you want to mask the query statement following `statement:` in the log with the string `PRIVATE_QUERY`, you can mask it by writing a regular expression pattern in `pattern` as follows.
```yaml
logs:
  - masking:
      - pattern: 'statement: .*'
        replace: 'statement: PRIVATE_QUERY'
```
