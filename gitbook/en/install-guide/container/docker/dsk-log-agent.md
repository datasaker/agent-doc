# dsk-log-agent

## Install Datasaker Log agent in Docker environment

A `Log agent` is an agent that collects, processes and transmits log data generated by systems or applications in near real time in various environments. It can be used to centrally manage and analyze log data generated by multiple servers through `Log agent`. As a result, users can quickly detect and respond to problems occurring in the system or applications. In addition, log data can be analyzed and used for various purposes such as security, performance, and business analysis. We tailor agent settings to your needs to deliver optimal results.

## Did you run the DataSaker predecessor?

If the preceding task of `DataSaker` has not been carried out in the current Docker environment, please proceed with the preceding task of `DataSaker` first. [DataSaker predecessor](dsk-log-agent/en/$%7BPREPARATION\_MANUAL\_KR%7D/)

## Install Log agent

To collect logs through log agent in Docker environment, the following tasks are required.

### 1. Create the configuration YAML file required to run the agent.

The log agent manages log collection settings through an agent configuration YAML file. The description of each setting item in the log agent configuration file is as follows.
```yaml
agent:
  metadata:
    agent_name:
    cluster_id:
  logs:
    - service:
      tag: []
      keyword: []
      multiline:
        format:
        pattern: []
      masking:
        - pattern:
          replace:
      collect:
        type:
        category:
        address:
        file:
          paths: []
          exclude_paths: []
        driver:
          containers: []
```
| **Settings** | **Description** | **Default** |
| ----------------------------------- | -------------------------------------------------------------------------------- |:----------------:|
| **metadata** | Agent basic information | |
| `agent_name` | log agent name | `dsk-log-agent` |
| `cluster_id` | Cluster information of the environment to be controlled | `unknown` |
| **logs** | Log collection target information | |
| `service` | Service name of the log collection destination | `default` |
| `tag` | Tag of log collection target | N/A |
| `keyword` | Log Collection Keywords (collects only logs containing keywords) | |
| **multiline** | Multi-line log collection settings | |
| `format` | multi-line log formats (eg go, java, ruby, python) | |
| `pattern` | Multi-line log pattern (e.g. ^\d{4}-\d{2}-\d{2}) - User custom regex pattern can be used | |
| **masking** | Sensitive information log masking settings | |
| `pattern` | Log pattern to mask (e.g. ^\d{4}-\d{2}-\d{2}) - user custom regex pattern available | |
| `replace` | The string where the masking pattern is to be replaced (eg ******) | |
| **collect** | Log Collection Target Settings | |
| `type` | Log collection method (write one value among `file` or `driver`) | `file` |
| `category` | service classification (write a value of one of `app`, `database`, `syslog`, `etc`) | `etc` |
| `address` | Database host and port information (set when the service category is database) | |
| **file** | If the log collection method is file, set | |
| `paths` | Log collection destination path (e.g. /var/log/sample/*.log) | `/var/log/*.log` |
| `exclude_paths` | Log collection exclusion target path | |
| **driver** | If log collection method is driver, Settings | |
| `containers` | Log collection target container name | `*` |

In a Docker environment, the log agent can collect logs in two ways.

* **driver** : Collect logs using the docker logging driver. Set the container name to collect. (If logs are output to standard output, use that method.)
* **file** : Collect the log file directly. Mount the logs to be collected directly on the log agent and set the relative path to the log file to be collected. (If logs are not output to standard output, use that method.)For example, if you collect logs for a container named awesome_saker via a logging driver, you could write a configuration file like this:
```shell
cat << EOF > ~/.datasaker/log-agent-config.yml
agent:
  logs:
    - collect:
        type: driver
        driver:
          containers:
           - awesome_saker
EOF
```
If you collect log files yourself, you can write a configuration file like this:
```shell
cat << EOF > ~/.datasaker/log-agent-config.yml
agent:
  logs:
    - collect:
        type: file
        file:
          paths:
           - /var/lib/docekr/containers/*awesome_saker*.log
EOF
```
### 2. Run the log agent using the docker command.

* (Required) Mount the configuration files required by the log agent. (global, agent YAML configuration files)
  * `-v ~/.datasaker/config.yml:/etc/datasaker/global-config.yml:ro`
  * `-v ~/.datasaker/log-agent-config.yml:/etc/datasaker/dsk-log-agent/agent-config.yml:ro`
  * **\[Note]** The global and agent configuration files must be written. If not written, the log agent may not operate normally.
* (When collecting via logging driver) Port forwarding settings are required.
  * `-p [HOST_PORT_NUMBER]:21212`
* (In case of collecting log files directly) Mount the logs the user wants to collect on the agent.
  * Set options as follows. `-v [COLLECT LOG PATH]:[LOG AGENT MOUNT PATH]:ro`
    * In that option, the path before ':' creates the path to collect logs, and the path after ':' creates the path of the agent to collect logs.
    * The log collection path of the agent configuration file must be created relative to the path `[LOG AGENT MOUNT PATH]`.

Here is an example log agent run:
```shell
docker  run -d --name dsk-log-agent \
  -v /var/datasaker/:/var/datasaker/ \
  -v ~/.datasaker/config.yml:/etc/datasaker/global-config.yml:ro \
  -v ~/.datasaker/log-agent-config.yml:/etc/datasaker/dsk-log-agent/agent-config.yml:ro \
  -v -v /var/lib/docker/containers/:/var/lib/docker/containers/:ro \
  -p 21212:21212 \
  --restart=always \
  datasaker/dsk-log-agent:latest
```
**\[Note]** If you collect log files yourself, you must mount the logs on the agent.

### 3. (If collecting via logging driver) Run the container for which you want to collect logs.

* Set required options for log collection.
  * `--log-driver=fluentd`
  * `--log-opt fluentd-address=[LOG_AGENT_HOST]:[LOG_AGENT_HOST_PORT_NUMBER]`

**\[Caution]** When collecting logs via the logging driver, you must restart the container for the log collection target.

The following is an example of running a container for log collection.
```shell
docker  run --log-driver=fluentd --log-opt fluentd-address=dsk-log-agent:21212 your/application
```
